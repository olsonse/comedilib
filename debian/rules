#!/usr/bin/make -f
# See debhelper(7) (uncomment to enable)
# output every command that modifies files on the build system.
DH_VERBOSE = 1

# see EXAMPLES in dpkg-buildflags(1) and read /usr/share/dpkg/*
DPKG_EXPORT_BUILDFLAGS = 1
include /usr/share/dpkg/default.mk

# see FEATURE AREAS in dpkg-buildflags(1)
export DEB_BUILD_MAINT_OPTIONS = hardening=+all

# see ENVIRONMENT in dpkg-buildflags(1)
# package maintainers to append CFLAGS
#export DEB_CFLAGS_MAINT_APPEND  = -Wall -pedantic
# package maintainers to append LDFLAGS
#export DEB_LDFLAGS_MAINT_APPEND = -Wl,--as-needed

# main packaging script based on dh7 syntax
%:
	dh $@ --with autoreconf

build binary :  $(CURDIR)/debian/changelog \
		$(CURDIR)/debian/libcomedi0.install \
		$(CURDIR)/debian/libcomedi-dev.install

define LIBCOMEDI0_INSTALL
usr/lib/${DEB_HOST_MULTIARCH}/libcomedi.so.*
#usr/lib/ruby/*
usr/sbin/*
#usr/bin/comedi_calibrate
usr/bin/comedi_test
usr/bin/comedi_board_info
usr/share/man/man1/*
usr/share/man/man7/*
usr/share/man/man8/*
usr/share/doc/comedilib/*.conf usr/share/doc/libcomedi0/
etc/pcmcia/*
lib/udev/*
endef
export LIBCOMEDI0_INSTALL

define LIBCOMEDI_DEV_INSTALL
usr/lib/${DEB_HOST_MULTIARCH}/libcomedi.so
usr/lib/${DEB_HOST_MULTIARCH}/libcomedi.a
usr/lib/${DEB_HOST_MULTIARCH}/libcomedi.la
usr/include/*
usr/share/man/man3/*
usr/share/doc/comedilib/* usr/share/doc/libcomedi-dev/
usr/lib/${DEB_HOST_MULTIARCH}/pkgconfig/comedilib.pc
endef
export LIBCOMEDI_DEV_INSTALL

override_dh_autoreconf:
	./autogen.sh

override_dh_auto_configure:
	dh_auto_configure -- --with-udev-hotplug=/lib \
			     --with-udev-group=iocard

override_dh_auto_install: install_demo_cfiles
	dh_auto_install

install_demo_cfiles:
	mkdir -p $(CURDIR)/debian/libcomedi-dev/usr/share/doc/libcomedi-dev/demo
	cp -a   $(CURDIR)/demo \
		$(CURDIR)/debian/libcomedi-dev/usr/share/doc/libcomedi-dev/
	rm -f   $(CURDIR)/debian/libcomedi-dev/usr/share/doc/libcomedi-dev/demo/Makefile*
	cp	$(CURDIR)/debian/Makefile.debian_demo \
		$(CURDIR)/debian/libcomedi-dev/usr/share/doc/libcomedi-dev/demo/Makefile
	cd 	$(CURDIR)/debian/libcomedi-dev/usr/share/doc/libcomedi-dev/demo \
		&& make clean && rm -f board_info* && rm -rf python

override_dh_compress:
	dh_compress -X.c

$(CURDIR)/debian/libcomedi0.install :
	@echo "$${LIBCOMEDI0_INSTALL}" > $(CURDIR)/debian/libcomedi0.install
$(CURDIR)/debian/libcomedi-dev.install :
	@echo "$${LIBCOMEDI_DEV_INSTALL}" > $(CURDIR)/debian/libcomedi-dev.install

$(CURDIR)/debian/changelog : $(CURDIR)/debian/mk_changelog
	$(CURDIR)/debian/mk_changelog > $(CURDIR)/debian/changelog
